// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadSection = document.getElementById('uploadSection');
const fileInfoSection = document.getElementById('fileInfoSection');
const conversionSection = document.getElementById('conversionSection');
const progressSection = document.getElementById('progressSection');
const downloadSection = document.getElementById('downloadSection');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
const imagePreview = document.getElementById('imagePreview');
const videoPreview = document.getElementById('videoPreview');
const audioPreview = document.getElementById('audioPreview');
const docPreview = document.getElementById('docPreview');
const fileTypeIcon = document.getElementById('fileTypeIcon');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const fileExtra = document.getElementById('fileExtra');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
const imageFormats = document.getElementById('imageFormats');
const videoFormats = document.getElementById('videoFormats');
const audioFormats = document.getElementById('audioFormats');
const documentFormats = document.getElementById('documentFormats');

const imageQualitySlider = document.getElementById('imageQualitySlider');
const imageQuality = document.getElementById('imageQuality');
const resizeCheck = document.getElementById('resizeCheck');
const resizeInputs = document.getElementById('resizeInputs');
const widthInput = document.getElementById('widthInput');
const heightInput = document.getElementById('heightInput');
const videoBitrate = document.getElementById('videoBitrate');
const audioBitrate = document.getElementById('audioBitrate');

// Ø§Ù„Ø£Ø²Ø±Ø§Ø±
const convertBtn = document.getElementById('convertBtn');
const changeFileBtn = document.getElementById('changeFileBtn');
const downloadBtn = document.getElementById('downloadBtn');
const convertAnotherBtn = document.getElementById('convertAnotherBtn');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ‚Ø¯Ù…
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const convertedInfo = document.getElementById('convertedInfo');

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let selectedFile = null;
let selectedFormat = null;
let uploadedFileId = null;
let uploadedFileType = null;
let downloadUrl = null;

// Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileSelect);
changeFileBtn.addEventListener('click', resetUpload);
convertBtn.addEventListener('click', startConversion);
downloadBtn.addEventListener('click', downloadFile);
convertAnotherBtn.addEventListener('click', resetUpload);

// Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙŠØºØ©
document.querySelectorAll('.format-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const parent = this.parentElement;
        parent.querySelectorAll('.format-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        selectedFormat = this.dataset.format;
    });
});

// Ø´Ø±ÙŠØ· Ø§Ù„Ø¬ÙˆØ¯Ø©
imageQualitySlider.addEventListener('input', (e) => {
    imageQuality.textContent = e.target.value;
});

// Ø®ÙŠØ§Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
resizeCheck.addEventListener('change', (e) => {
    resizeInputs.style.display = e.target.checked ? 'flex' : 'none';
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        handleFile(file);
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù
function handleFile(file) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù…
    if (file.size > 500 * 1024 * 1024) {
        alert('âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
        return;
    }

    selectedFile = file;
    displayFileInfo(file);
    uploadFile(file);
}

// Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
function displayFileInfo(file) {
    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const type = getFileCategory(file);

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
    imagePreview.style.display = 'none';
    videoPreview.style.display = 'none';
    audioPreview.style.display = 'none';
    docPreview.style.display = 'none';

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    const reader = new FileReader();

    switch(type) {
        case 'image':
            fileTypeIcon.textContent = 'ğŸ–¼ï¸';
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©
                const img = new Image();
                img.onload = () => {
                    fileExtra.textContent = `Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${img.width} Ã— ${img.height} Ø¨ÙƒØ³Ù„`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            break;

        case 'video':
            fileTypeIcon.textContent = 'ğŸ¬';
            reader.onload = (e) => {
                videoPreview.src = e.target.result;
                videoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            fileExtra.textContent = 'Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ';
            break;

        case 'audio':
            fileTypeIcon.textContent = 'ğŸµ';
            reader.onload = (e) => {
                audioPreview.src = e.target.result;
                audioPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            fileExtra.textContent = 'Ù…Ù„Ù ØµÙˆØªÙŠ';
            break;

        case 'document':
            fileTypeIcon.textContent = 'ğŸ“„';
            docPreview.style.display = 'flex';
            fileExtra.textContent = 'Ù…Ø³ØªÙ†Ø¯';
            break;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    fileName.textContent = `Ø§Ù„Ø§Ø³Ù…: ${file.name}`;
    fileSize.textContent = `Ø§Ù„Ø­Ø¬Ù…: ${formatBytes(file.size)}`;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    showConversionOptions(type);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ÙØ¹ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    uploadSection.style.display = 'none';
    fileInfoSection.style.display = 'grid';
    conversionSection.style.display = 'block';
}

// ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø© Ø§Ù„Ù…Ù„Ù
function getFileCategory(file) {
    const type = file.type;
    const name = file.name.toLowerCase();

    if (type.startsWith('image/')) return 'image';
    if (type.startsWith('video/')) return 'video';
    if (type.startsWith('audio/')) return 'audio';

    // Ø­Ø³Ø¨ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
    if (name.match(/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/)) return 'image';
    if (name.match(/\.(mp4|avi|mov|wmv|flv|mkv|webm)$/)) return 'video';
    if (name.match(/\.(mp3|wav|ogg|m4a|flac|aac|wma)$/)) return 'audio';
    if (name.match(/\.(pdf|doc|docx|txt|rtf)$/)) return 'document';

    return 'unknown';
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„
function showConversionOptions(type) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    imageFormats.style.display = 'none';
    videoFormats.style.display = 'none';
    audioFormats.style.display = 'none';
    documentFormats.style.display = 'none';

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    switch(type) {
        case 'image':
            imageFormats.style.display = 'block';
            break;
        case 'video':
            videoFormats.style.display = 'block';
            break;
        case 'audio':
            audioFormats.style.display = 'block';
            break;
        case 'document':
            documentFormats.style.display = 'block';
            break;
    }
}

// Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            uploadedFileId = result.fileId;
            uploadedFileType = result.fileType;
            console.log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
        } else {
            throw new Error(result.error || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);
        resetUpload();
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„
async function startConversion() {
    if (!uploadedFileId) {
        alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹!');
        return;
    }

    if (!selectedFormat) {
        alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙŠØºØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„!');
        return;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
    conversionSection.style.display = 'none';
    progressSection.style.display = 'block';
    progressText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„
    const conversionData = {
        fileId: uploadedFileId,
        format: selectedFormat,
        fileType: uploadedFileType
    };

    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    if (uploadedFileType === 'image') {
        conversionData.quality = imageQualitySlider.value;
        if (resizeCheck.checked) {
            if (widthInput.value) conversionData.width = widthInput.value;
            if (heightInput.value) conversionData.height = heightInput.value;
        }
    } else if (uploadedFileType === 'video') {
        conversionData.videoBitrate = videoBitrate.value;
    } else if (uploadedFileType === 'audio') {
        conversionData.audioBitrate = audioBitrate.value;
    }

    try {
        // Ø¨Ø¯Ø¡ Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ø¯Ù…
        animateProgress();

        const response = await fetch('/api/convert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(conversionData)
        });

        const result = await response.json();

        if (result.success) {
            downloadUrl = result.downloadUrl;
            convertedInfo.textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙˆÙ„: ${result.fileName}`;
            showDownloadSection();
        } else {
            throw new Error(result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ' + error.message);
        progressSection.style.display = 'none';
        conversionSection.style.display = 'block';
    }
}

// ØªØ­Ø±ÙŠÙƒ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function animateProgress() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 90) {
            progress = 90;
            clearInterval(interval);
        }
        progressFill.style.width = `${progress}%`;
    }, 300);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showDownloadSection() {
    progressFill.style.width = '100%';
    progressText.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„! âœ…';

    setTimeout(() => {
        progressSection.style.display = 'none';
        downloadSection.style.display = 'block';
    }, 800);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
function downloadFile() {
    if (downloadUrl) {
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.click();
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
function resetUpload() {
    selectedFile = null;
    selectedFormat = null;
    uploadedFileId = null;
    uploadedFileType = null;
    downloadUrl = null;
    fileInput.value = '';

    uploadSection.style.display = 'block';
    fileInfoSection.style.display = 'none';
    conversionSection.style.display = 'none';
    progressSection.style.display = 'none';
    downloadSection.style.display = 'none';

    document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('selected'));
    imageQualitySlider.value = 90;
    imageQuality.textContent = '90';
    resizeCheck.checked = false;
    resizeInputs.style.display = 'none';
    widthInput.value = '';
    heightInput.value = '';
    progressFill.style.width = '0%';
}

// ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}